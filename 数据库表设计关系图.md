# 碎时拾光 - 数据库表设计关系图

## 1. 数据库概览

### 1.1 数据库信息
- **数据库名称**: `fragment_time_db`
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`
- **存储引擎**: `InnoDB`
- **数据库版本**: `MySQL 8.0+`

### 1.2 表结构概览

| 表名 | 中文名称 | 主要功能 | 记录数预估 |
|------|----------|----------|------------|
| `user` | 用户表 | 存储用户基本信息 | 10万+ |
| `fixed_task` | 固定任务表 | 存储用户的固定日程安排 | 100万+ |
| `fragment_task` | 碎片任务表 | 记录用户完成的碎片活动 | 500万+ |
| `recommend_activity` | 推荐活动表 | 存储系统推荐的活动库 | 1000+ |
| `user_preference` | 用户偏好表 | 记录用户对推荐活动的偏好 | 50万+ |
| `report` | 报告表 | 存储生成的日报和周报 | 200万+ |
| `email_log` | 邮件日志表 | 记录邮件发送历史 | 100万+ |

## 2. 数据库ER图

```
                    ┌─────────────────────────────────────────────────────────────┐
                    │                        碎时拾光数据库ER图                      │
                    └─────────────────────────────────────────────────────────────┘

    ┌─────────────────┐                    ┌─────────────────┐                    ┌─────────────────┐
    │      user       │                    │  fixed_task     │                    │ fragment_task   │
    │                 │                    │                 │                    │                 │
    │ • id (PK)       │◄──────────────────►│ • id (PK)       │                    │ • id (PK)       │
    │ • username      │        1:N         │ • user_id (FK)  │                    │ • user_id (FK)  │
    │ • password      │                    │ • title         │                    │ • activity_id   │
    │ • email         │                    │ • start_time    │                    │ • start_time    │
    │ • phone         │                    │ • end_time      │                    │ • end_time      │
    │ • profession    │                    │ • repeat_type   │                    │ • status        │
    │ • skills        │                    │ • description   │                    │ • feedback      │
    │ • goals         │                    │ • create_time   │                    │ • create_time   │
    │ • email_subscribe│                   │ • update_time   │                    │ • update_time   │
    │ • create_time   │                    │ • deleted       │                    │ • deleted       │
    │ • update_time   │                    └─────────────────┘                    └─────────────────┘
    │ • deleted       │                             │                                       │
    └─────────────────┘                             │                                       │
             │                                      │                                       │
             │ 1:N                                  │                                       │
             ▼                                      │                                       │
    ┌─────────────────┐                             │                                       │
    │ user_preference │                             │                                       │
    │                 │                             │                                       │
    │ • id (PK)       │                             │                                       │
    │ • user_id (FK)  │                             │                                       │
    │ • activity_id   │◄────────────────────────────┼───────────────────────────────────────┘
    │ • preference    │                             │                              N:1
    │ • completion    │                             │
    │ • create_time   │                             │
    │ • update_time   │                             │
    └─────────────────┘                             │
             │                                      │
             │ N:1                                  │
             ▼                                      │
    ┌─────────────────┐                             │
    │recommend_activity│◄────────────────────────────┘
    │                 │                      N:1
    │ • id (PK)       │
    │ • title         │
    │ • description   │
    │ • category      │
    │ • duration      │
    │ • difficulty    │
    │ • skills_required│
    │ • profession_match│
    │ • popularity    │
    │ • create_time   │
    │ • update_time   │
    │ • deleted       │
    └─────────────────┘

    ┌─────────────────┐                    ┌─────────────────┐
    │     report      │                    │   email_log     │
    │                 │                    │                 │
    │ • id (PK)       │                    │ • id (PK)       │
    │ • user_id (FK)  │◄──────────────────►│ • user_id (FK)  │
    │ • report_type   │        1:N         │ • email_type    │
    │ • report_date   │                    │ • recipient     │
    │ • content       │                    │ • subject       │
    │ • statistics    │                    │ • content       │
    │ • create_time   │                    │ • send_status   │
    │ • update_time   │                    │ • send_time     │
    └─────────────────┘                    │ • error_message │
             │                             │ • retry_count   │
             │ N:1                         │ • create_time   │
             ▼                             └─────────────────┘
    ┌─────────────────┐
    │      user       │
    │   (引用上方)     │
    └─────────────────┘
```

## 3. 核心表详细设计

### 3.1 用户表 (user)

**表名**: `user`  
**功能**: 存储用户基本信息和账户设置

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 用户ID，主键 |
| username | VARCHAR | 50 | NOT NULL | - | UNIQUE | 用户名，唯一 |
| password | VARCHAR | 255 | NOT NULL | - | - | 密码，BCrypt加密 |
| email | VARCHAR | 100 | NOT NULL | - | UNIQUE | 邮箱，唯一 |
| phone | VARCHAR | 20 | NULL | - | INDEX | 手机号 |
| profession | VARCHAR | 100 | NULL | - | INDEX | 职业 |
| skills | TEXT | - | NULL | - | - | 技能标签，逗号分隔 |
| goals | TEXT | - | NULL | - | - | 提升目标 |
| email_subscribe | TINYINT | 1 | NOT NULL | 1 | - | 邮件订阅开关 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |
| deleted | TINYINT | 1 | NOT NULL | 0 | INDEX | 软删除标记 |

**索引设计**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `username`, `email`
- INDEX: `phone`, `profession`, `deleted`

### 3.2 固定任务表 (fixed_task)

**表名**: `fixed_task`  
**功能**: 存储用户的固定日程安排

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 任务ID，主键 |
| user_id | BIGINT | - | NOT NULL | - | INDEX | 用户ID，外键 |
| title | VARCHAR | 200 | NOT NULL | - | - | 任务标题 |
| start_time | DATETIME | - | NOT NULL | - | INDEX | 开始时间 |
| end_time | DATETIME | - | NOT NULL | - | INDEX | 结束时间 |
| repeat_type | VARCHAR | 20 | NOT NULL | 'none' | - | 重复类型：none/daily/weekly/monthly |
| description | TEXT | - | NULL | - | - | 任务描述 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |
| deleted | TINYINT | 1 | NOT NULL | 0 | INDEX | 软删除标记 |

**索引设计**:
- PRIMARY KEY: `id`
- INDEX: `user_id`, `start_time`, `end_time`, `deleted`
- COMPOSITE INDEX: `user_id_time` (`user_id`, `start_time`, `end_time`)

**外键约束**:
- `user_id` REFERENCES `user(id)` ON DELETE CASCADE

### 3.3 碎片任务表 (fragment_task)

**表名**: `fragment_task`  
**功能**: 记录用户完成的碎片活动

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 任务ID，主键 |
| user_id | BIGINT | - | NOT NULL | - | INDEX | 用户ID，外键 |
| activity_id | BIGINT | - | NULL | - | INDEX | 推荐活动ID，外键 |
| title | VARCHAR | 200 | NOT NULL | - | - | 活动标题 |
| start_time | DATETIME | - | NOT NULL | - | INDEX | 开始时间 |
| end_time | DATETIME | - | NOT NULL | - | INDEX | 结束时间 |
| duration | INT | - | NOT NULL | - | - | 实际时长（分钟） |
| status | VARCHAR | 20 | NOT NULL | 'completed' | INDEX | 状态：completed/abandoned |
| feedback | TINYINT | 1 | NULL | - | - | 用户反馈：1-5分 |
| notes | TEXT | - | NULL | - | - | 用户备注 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |
| deleted | TINYINT | 1 | NOT NULL | 0 | INDEX | 软删除标记 |

**索引设计**:
- PRIMARY KEY: `id`
- INDEX: `user_id`, `activity_id`, `start_time`, `status`, `deleted`
- COMPOSITE INDEX: `user_time` (`user_id`, `start_time`)

**外键约束**:
- `user_id` REFERENCES `user(id)` ON DELETE CASCADE
- `activity_id` REFERENCES `recommend_activity(id)` ON DELETE SET NULL

### 3.4 推荐活动表 (recommend_activity)

**表名**: `recommend_activity`  
**功能**: 存储系统推荐的活动库

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 活动ID，主键 |
| title | VARCHAR | 200 | NOT NULL | - | INDEX | 活动标题 |
| description | TEXT | - | NOT NULL | - | - | 活动描述 |
| category | VARCHAR | 50 | NOT NULL | - | INDEX | 活动分类 |
| duration | INT | - | NOT NULL | - | INDEX | 建议时长（分钟） |
| difficulty | TINYINT | 1 | NOT NULL | 1 | INDEX | 难度等级：1-5 |
| skills_required | VARCHAR | 500 | NULL | - | - | 所需技能，逗号分隔 |
| profession_match | VARCHAR | 200 | NULL | - | INDEX | 适合职业，逗号分隔 |
| popularity | INT | - | NOT NULL | 0 | INDEX | 受欢迎程度 |
| tags | VARCHAR | 500 | NULL | - | - | 标签，逗号分隔 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |
| deleted | TINYINT | 1 | NOT NULL | 0 | INDEX | 软删除标记 |

**索引设计**:
- PRIMARY KEY: `id`
- INDEX: `title`, `category`, `duration`, `difficulty`, `profession_match`, `popularity`, `deleted`

### 3.5 用户偏好表 (user_preference)

**表名**: `user_preference`  
**功能**: 记录用户对推荐活动的偏好

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 偏好ID，主键 |
| user_id | BIGINT | - | NOT NULL | - | INDEX | 用户ID，外键 |
| activity_id | BIGINT | - | NOT NULL | - | INDEX | 活动ID，外键 |
| preference_score | DECIMAL | 3,2 | NOT NULL | 0.00 | - | 偏好分数：0.00-1.00 |
| completion_count | INT | - | NOT NULL | 0 | - | 完成次数 |
| total_recommended | INT | - | NOT NULL | 0 | - | 推荐总次数 |
| avg_feedback | DECIMAL | 3,2 | NULL | - | - | 平均反馈分数 |
| last_completed | DATETIME | - | NULL | - | - | 最后完成时间 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |

**索引设计**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `user_activity` (`user_id`, `activity_id`)
- INDEX: `user_id`, `activity_id`

**外键约束**:
- `user_id` REFERENCES `user(id)` ON DELETE CASCADE
- `activity_id` REFERENCES `recommend_activity(id)` ON DELETE CASCADE

### 3.6 报告表 (report)

**表名**: `report`  
**功能**: 存储生成的日报和周报

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 报告ID，主键 |
| user_id | BIGINT | - | NOT NULL | - | INDEX | 用户ID，外键 |
| report_type | VARCHAR | 20 | NOT NULL | - | INDEX | 报告类型：daily/weekly |
| report_date | DATE | - | NOT NULL | - | INDEX | 报告日期 |
| title | VARCHAR | 200 | NOT NULL | - | - | 报告标题 |
| content | JSON | - | NOT NULL | - | - | 报告内容，JSON格式 |
| statistics | JSON | - | NULL | - | - | 统计数据，JSON格式 |
| email_sent | TINYINT | 1 | NOT NULL | 0 | - | 是否已发送邮件 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |

**索引设计**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `user_report` (`user_id`, `report_type`, `report_date`)
- INDEX: `user_id`, `report_type`, `report_date`

**外键约束**:
- `user_id` REFERENCES `user(id)` ON DELETE CASCADE

### 3.7 邮件日志表 (email_log)

**表名**: `email_log`  
**功能**: 记录邮件发送历史

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 日志ID，主键 |
| user_id | BIGINT | - | NOT NULL | - | INDEX | 用户ID，外键 |
| email_type | VARCHAR | 50 | NOT NULL | - | INDEX | 邮件类型：register/report/notification |
| recipient | VARCHAR | 100 | NOT NULL | - | - | 收件人邮箱 |
| subject | VARCHAR | 200 | NOT NULL | - | - | 邮件主题 |
| content | TEXT | - | NULL | - | - | 邮件内容 |
| send_status | VARCHAR | 20 | NOT NULL | 'pending' | INDEX | 发送状态：pending/success/failed |
| send_time | DATETIME | - | NULL | - | INDEX | 发送时间 |
| error_message | TEXT | - | NULL | - | - | 错误信息 |
| retry_count | TINYINT | 1 | NOT NULL | 0 | - | 重试次数 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |

**索引设计**:
- PRIMARY KEY: `id`
- INDEX: `user_id`, `email_type`, `send_status`, `send_time`

**外键约束**:
- `user_id` REFERENCES `user(id)` ON DELETE CASCADE

## 4. 表关系说明

### 4.1 一对多关系 (1:N)

1. **user → fixed_task**: 一个用户可以有多个固定任务
2. **user → fragment_task**: 一个用户可以完成多个碎片任务
3. **user → user_preference**: 一个用户可以有多个活动偏好
4. **user → report**: 一个用户可以有多个报告
5. **user → email_log**: 一个用户可以有多个邮件记录
6. **recommend_activity → fragment_task**: 一个推荐活动可以被多个用户完成
7. **recommend_activity → user_preference**: 一个推荐活动可以被多个用户偏好

### 4.2 多对多关系 (M:N)

1. **user ↔ recommend_activity**: 通过 `user_preference` 表实现
   - 用户可以对多个活动有偏好
   - 活动可以被多个用户偏好

## 5. 数据完整性约束

### 5.1 主键约束
- 所有表都有自增主键 `id`
- 确保每条记录的唯一性

### 5.2 外键约束
- 所有 `user_id` 字段都引用 `user.id`
- `activity_id` 引用 `recommend_activity.id`
- 删除策略：CASCADE（级联删除）或 SET NULL

### 5.3 唯一性约束
- `user.username` 和 `user.email` 必须唯一
- `user_preference` 表的 (`user_id`, `activity_id`) 组合唯一
- `report` 表的 (`user_id`, `report_type`, `report_date`) 组合唯一

### 5.4 检查约束
- `user.email_subscribe` 只能是 0 或 1
- `fragment_task.feedback` 只能是 1-5
- `recommend_activity.difficulty` 只能是 1-5
- `user_preference.preference_score` 范围 0.00-1.00

## 6. 索引优化策略

### 6.1 查询优化索引
- **时间范围查询**: `start_time`, `end_time` 建立索引
- **用户数据查询**: `user_id` 建立索引
- **分类筛选**: `category`, `profession` 建立索引
- **状态筛选**: `status`, `deleted` 建立索引

### 6.2 复合索引
- `fixed_task`: (`user_id`, `start_time`, `end_time`) - 查询用户时间段内的任务
- `fragment_task`: (`user_id`, `start_time`) - 查询用户的碎片任务历史
- `user_preference`: (`user_id`, `activity_id`) - 查询用户对特定活动的偏好

### 6.3 覆盖索引
- 对于频繁查询的字段组合，建立覆盖索引减少回表查询
- 例如：查询用户基本信息时，可以建立 (`id`, `username`, `email`) 覆盖索引

## 7. 分区策略

### 7.1 时间分区
- `fragment_task` 表按月分区，提高历史数据查询性能
- `email_log` 表按月分区，便于日志管理和清理
- `report` 表按年分区，长期存储报告数据

### 7.2 分区示例
```sql
-- fragment_task 按月分区
PARTITION BY RANGE (YEAR(create_time) * 100 + MONTH(create_time)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    ...
);
```

## 8. 数据归档策略

### 8.1 归档规则
- **fragment_task**: 保留2年数据，超过2年的数据归档到历史表
- **email_log**: 保留1年数据，超过1年的数据归档
- **report**: 永久保留，但可以压缩存储

### 8.2 清理策略
- **软删除数据**: 定期清理 `deleted=1` 的数据
- **临时数据**: 清理失败的邮件发送记录
- **缓存数据**: Redis中的过期数据自动清理

---

**文档版本**: v1.0  
**创建时间**: 2025-01-20  
**更新时间**: 2025-01-20  
**维护人员**: 数据库团队