# 碎时拾光 - 系统架构设计文档

## 1. 项目概述

「碎时拾光」是一个基于Spring Boot + Vue3的前后端分离项目，专注于碎片时间管理、AI智能推荐和自动报告推送。核心理念是"从用户日程中主动挖掘价值"，通过分析用户空闲时间，推荐个性化的提升活动。

### 1.1 核心功能
- 用户中心：注册/登录、个人信息管理、账号设置
- 任务管理：固定任务录入、碎片任务记录
- 日程分析：自动识别空闲时段
- AI推荐引擎：智能推荐提升活动
- 报告与推送：生成日报/周报，邮件自动推送

### 1.2 技术栈
- **后端**: Spring Boot 3.x + MySQL + Redis + MyBatis Plus
- **前端**: Vue3 + Vite + Element Plus + ECharts + Pinia
- **外部服务**: SMTP邮件服务、AI推荐引擎

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端层 (Vue3)  │    │   网关层 (Nginx) │    │   外部服务层     │
│                 │    │                 │    │                 │
│ • 用户界面      │    │ • 负载均衡      │    │ • SMTP邮件服务  │
│ • 路由管理      │◄──►│ • 静态资源      │    │ • AI推荐API     │
│ • 状态管理      │    │ • 反向代理      │    │ • 第三方登录    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Spring Boot)                      │
│                                                                 │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │ 用户管理模块 │ │ 任务管理模块 │ │ 推荐引擎模块 │ │ 报告推送模块 │ │
│ │             │ │             │ │             │ │             │ │
│ │ • 用户认证  │ │ • 固定任务  │ │ • 规则引擎  │ │ • 日报生成  │ │
│ │ • 权限管理  │ │ • 碎片任务  │ │ • 活动推荐  │ │ • 周报生成  │ │
│ │ • 个人信息  │ │ • 日程分析  │ │ • 偏好学习  │ │ • 邮件推送  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据访问层     │    │   缓存层 (Redis) │    │   数据库层       │
│                 │    │                 │    │                 │
│ • MyBatis Plus  │    │ • 用户会话      │    │ • MySQL 8.0     │
│ • 数据映射      │◄──►│ • 空闲时间缓存  │◄──►│ • 主从复制      │
│ • 事务管理      │    │ • 推荐结果缓存  │    │ • 读写分离      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 分层架构

#### 2.2.1 表现层 (Presentation Layer)
- **Controller层**: 处理HTTP请求，参数验证，响应格式化
- **DTO/VO层**: 数据传输对象和视图对象
- **异常处理**: 全局异常处理器，统一错误响应

#### 2.2.2 业务逻辑层 (Business Layer)
- **Service层**: 核心业务逻辑实现
- **推荐引擎**: AI推荐算法和规则引擎
- **定时任务**: 报告生成和数据清理

#### 2.2.3 数据访问层 (Data Access Layer)
- **Mapper层**: MyBatis数据访问接口
- **Entity层**: 数据库实体映射
- **缓存层**: Redis缓存策略

## 3. 核心模块设计

### 3.1 用户管理模块

```
┌─────────────────────────────────────────────────────────────┐
│                        用户管理模块                          │
│                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 用户注册    │ │ 用户登录    │ │ 个人信息    │ │ 权限管理│ │
│ │             │ │             │ │             │ │         │ │
│ │ • 邮箱验证  │ │ • JWT认证   │ │ • 职业设置  │ │ • 角色  │ │
│ │ • 密码加密  │ │ • 会话管理  │ │ • 技能标签  │ │ • 权限  │ │
│ │ • 信息完善  │ │ • 自动续期  │ │ • 提升目标  │ │ • 访问  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**核心功能**:
- JWT令牌认证，24小时有效期
- BCrypt密码加密，盐值长度12
- 用户信息缓存到Redis，1小时过期
- 支持邮箱验证和密码重置

### 3.2 任务管理模块

```
┌─────────────────────────────────────────────────────────────┐
│                        任务管理模块                          │
│                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 固定任务    │ │ 碎片任务    │ │ 日程分析    │ │ 时间计算│ │
│ │             │ │             │ │             │ │         │ │
│ │ • 时间设置  │ │ • 活动记录  │ │ • 空闲识别  │ │ • 冲突  │ │
│ │ • 冲突检测  │ │ • 完成状态  │ │ • 时段计算  │ │ • 重叠  │ │
│ │ • 重复规则  │ │ • 时长统计  │ │ • 缓存策略  │ │ • 跨天  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**核心算法**:
- 空闲时间计算：排序固定任务后遍历计算空白区间
- 时间冲突检测：通过start_time和end_time查询重叠
- 跨天任务处理：使用LocalDateTime处理时区和跨天逻辑

### 3.3 AI推荐引擎

```
┌─────────────────────────────────────────────────────────────┐
│                       AI推荐引擎                            │
│                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 规则引擎    │ │ 活动库管理  │ │ 偏好学习    │ │ 推荐算法│ │
│ │             │ │             │ │             │ │         │ │
│ │ • 职业匹配  │ │ • 分类管理  │ │ • 完成率    │ │ • 协同  │ │
│ │ • 技能匹配  │ │ • 难度分级  │ │ • 反馈收集  │ │ • 内容  │ │
│ │ • 时长匹配  │ │ • 内容更新  │ │ • 权重调整  │ │ • 混合  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**推荐策略**:
1. **初期规则引擎**: 基于职业+技能标签+时长的规则匹配
2. **中期机器学习**: 基于用户行为的协同过滤
3. **后期深度学习**: 接入GPT API进行个性化推荐

### 3.4 报告推送模块

```
┌─────────────────────────────────────────────────────────────┐
│                       报告推送模块                          │
│                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 数据统计    │ │ 报告生成    │ │ 邮件推送    │ │ 模板管理│ │
│ │             │ │             │ │             │ │         │ │
│ │ • 任务汇总  │ │ • 日报生成  │ │ • SMTP配置  │ │ • HTML  │ │
│ │ • 时间统计  │ │ • 周报生成  │ │ • 发送队列  │ │ • 图表  │ │
│ │ • 完成率    │ │ • 图表渲染  │ │ • 重试机制  │ │ • 样式  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**定时任务**:
- 日报：每日20:00生成，汇总当日任务和碎片时间利用
- 周报：每周日20:00生成，包含周统计和下周建议
- 数据清理：每月清理过期缓存和临时数据

## 4. 数据流程

### 4.1 用户注册流程
```
用户填写注册信息 → 后端验证 → 密码加密 → 存储数据库 → 返回成功
     ↓
邮箱验证(可选) → 激活账户 → 完善个人信息 → 生成JWT → 登录成功
```

### 4.2 任务管理流程
```
添加固定任务 → 时间冲突检测 → 存储数据库 → 更新空闲时间缓存
     ↓
系统定时计算 → 分析空闲时段 → 缓存到Redis → 推荐活动匹配
     ↓
用户查看推荐 → 选择活动 → 记录碎片任务 → 更新完成状态
```

### 4.3 推荐引擎流程
```
获取用户信息 → 查询空闲时间 → 匹配活动库 → 计算推荐分数
     ↓
排序TOP3活动 → 缓存推荐结果 → 返回给前端 → 用户反馈收集
     ↓
更新用户偏好 → 调整推荐权重 → 优化推荐算法 → 提升准确率
```

### 4.4 报告生成流程
```
定时任务触发 → 查询用户数据 → 统计分析 → 生成报告内容
     ↓
渲染邮件模板 → SMTP发送 → 记录发送状态 → 失败重试机制
```

## 5. 技术选型说明

### 5.1 后端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| Spring Boot | 3.x | 基础框架 | 成熟稳定，生态丰富 |
| MySQL | 8.0 | 主数据库 | 事务支持，数据一致性 |
| Redis | 7.x | 缓存数据库 | 高性能，支持多种数据结构 |
| MyBatis Plus | 3.x | ORM框架 | 简化CRUD，代码生成 |
| JWT | - | 认证授权 | 无状态，跨域支持 |
| Spring Mail | - | 邮件服务 | 集成简单，支持模板 |

### 5.2 前端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| Vue3 | 3.x | 前端框架 | 响应式，组合式API |
| Vite | 4.x | 构建工具 | 快速热更新，ES模块 |
| Element Plus | 2.x | UI组件库 | 组件丰富，文档完善 |
| ECharts | 5.x | 图表库 | 功能强大，可定制性高 |
| Pinia | 2.x | 状态管理 | 轻量级，TypeScript支持 |
| Axios | 1.x | HTTP客户端 | 拦截器，请求/响应处理 |

## 6. 部署架构

### 6.1 开发环境
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   前端开发   │  │   后端开发   │  │   数据库     │
│             │  │             │  │             │
│ npm run dev │  │ mvn spring  │  │ Docker      │
│ localhost   │  │ -boot:run   │  │ Compose     │
│ :3000       │  │ :8080       │  │ MySQL+Redis │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 6.2 生产环境
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   负载均衡   │  │   应用服务   │  │   数据服务   │
│             │  │             │  │             │
│ Nginx       │  │ Spring Boot │  │ 云数据库    │
│ 静态资源    │  │ JAR部署     │  │ RDS+Redis   │
│ 反向代理    │  │ 多实例      │  │ 主从复制    │
└─────────────┘  └─────────────┘  └─────────────┘
```

## 7. 性能优化策略

### 7.1 数据库优化
- 索引优化：为查询频繁的字段添加索引
- 分页查询：大数据量查询使用分页，单页最大100条
- 读写分离：主库写入，从库查询
- 连接池：使用HikariCP连接池

### 7.2 缓存策略
- 多级缓存：本地缓存 + Redis缓存
- 缓存预热：系统启动时预加载热点数据
- 缓存更新：数据变更时主动刷新缓存
- 缓存穿透：布隆过滤器防止无效查询

### 7.3 异步处理
- 邮件发送：使用异步队列，避免阻塞
- 报告生成：后台定时任务处理
- 推荐计算：异步计算，结果缓存

## 8. 安全设计

### 8.1 认证授权
- JWT令牌：无状态认证，支持分布式
- 密码加密：BCrypt加密，盐值随机
- 会话管理：Redis存储会话信息
- 权限控制：基于角色的访问控制(RBAC)

### 8.2 数据安全
- SQL注入：使用参数化查询
- XSS攻击：输入输出过滤
- CSRF攻击：Token验证
- 敏感信息：配置文件加密存储

### 8.3 接口安全
- 访问频率限制：Redis + AOP实现
- 参数验证：@Valid注解验证
- 异常处理：统一异常处理，避免信息泄露
- 日志记录：记录关键操作日志

## 9. 监控运维

### 9.1 应用监控
- Spring Boot Actuator：健康检查，指标监控
- 日志管理：Logback配置，分级记录
- 性能监控：JVM监控，接口响应时间
- 异常告警：关键异常实时通知

### 9.2 数据库监控
- 连接池监控：连接数，等待时间
- 慢查询监控：SQL执行时间分析
- 存储监控：磁盘使用率，表大小
- 备份策略：定期备份，异地存储

## 10. 扩展规划

### 10.1 功能扩展
- 移动端APP：React Native或Flutter开发
- 微信小程序：碎片时间管理小程序
- 社交功能：好友PK，排行榜
- AI升级：接入GPT API，更智能推荐

### 10.2 技术升级
- 微服务架构：Spring Cloud拆分服务
- 消息队列：RabbitMQ或Kafka
- 搜索引擎：Elasticsearch全文搜索
- 大数据分析：Spark分析用户行为

---

**文档版本**: v1.0  
**创建时间**: 2025-01-20  
**更新时间**: 2025-01-20  
**维护人员**: 开发团队